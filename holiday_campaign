<div class="flexslider text-center">
    <ul class="slides" id="time_banner">
        <script id="banner_template" type="x-tmpl-mustache/text">
            <li class="position_relative">
                {{#url}}
                <a href="{{url}}">
                {{/url}}
                    <div class="hero_banner holiday_campaign_banner center_content" style="background-image: url({{image_url}})">
                        <h2 class="banner_header">{{name}}</h2>
                        <p>{{description}}</p>
                    </div>
                </a>
            </li>    
        </script>
    </ul>
</div>
<!--FIRST BOX-->
<div class="content_container main_container container_bottom_border hol_box hol_box_1 margin_25_across">
    <div class="details_flex_container">
        <div class="details_img_container">
            <img id="box_1_image" src="" alt="">
        </div>
        <div class="details_info_container">
            <h2 class="details_title" id="box_1_title"></h2>
            <div class="details_info" id="box_1_desc"></div>
        </div>
    </div>
</div>
<!--SECOND BOX -->
<div class="content_container main_container container_bottom_border hol_box margin_25_across">
    <div class="details_flex_container left_column_reverse">
        <div class="left_details_info_container">
            <h2 class="details_title" id="box_2_title"></h2>
            <div class="details_info" id="box_2_desc"></div>
        </div>
        <div class="left_details_img_container">
            <img id="box_2_image" src="" alt="">
        </div>
    </div>
</div>
<!--THIRD BOX -->
<div class="content_container main_container container_bottom_border hol_box margin_25_across">
    <div class="details_flex_container">
        <div class="details_img_container">
            <img id="box_3_page_image" src="" alt="">
        </div>
        <div class="details_info_container">
            <h2 class="details_title" id="box_3_page_title"></h2>
            <div class="details_info" id="box_3_page_desc"></div>
        </div>
    </div>
</div>
<!--HOLIDAY HOURS-->
<div class="content_container main_container margin_25_across">
    <div class="hol_campaign_spacing">
        <h2 class="details_title hol_title">Holiday Hours</h2>
        
        <div class="row extended_hours_container" id="holidays_hours_container">
            <script id="holidays_hours_template" type="x-tmpl-mustache/text">
                <div class="holiday_dates">
                    
                    <span>{{formatted_date}}</span>
                    
                </div>
                <div class="holiday_hrs ">
                    <span>{{h}}</span>
                </div>
            </script>
        </div>
    </div>
</div>
<!--HOLIDAY EVENTS -->
<div id="holiday_events" class="content_container main_container margin_25_across hidden_now">
    <div class="hol_campaign_spacing">
        <h2 class="details_title hol_title">Holiday Events</h2>
        <div id="promos_container" class="row">
            <script id="promos_template" type="x-tmpl-mustache/text">
                <div class="col-md-4 col-sm-6">
                    <div class="promo_item">
                        <div class="store_logo_container">
                            <img class="transparent_logo" src="//codecloud.cdn.speedyrails.net/sites/5b1550796e6f641cab010000/image/png/1536094421888/default_background.png" alt="">
                            <img class="store_img" src="{{image_url}}" alt="{{name}}" />
                        </div>
                        <h2 class="promo_list_name text-center">{{short_name}}</h2>
                        <p class="promo_store promo_store_hol text-center">{{store_name}}</p>
                        <p class="promo_dates text-center">{{dates}}</p>
               
                        <p class="text-center"><a class="read_more" href="/events/{{slug}}">See Event Details</a></p>
                        
                    </div>
                </div>
            </script>
        </div>
    </div>
</div>
<!--FOURTH BOX -->
<div class="application-info">
    <div class="content_container main_container margin_25_across">
        <div class="hol_campaign_spacing">
            <h2 class="details_title hol_title" id="box_4_title"></h2>
            <div id="box_4_desc">
                <script id="sponsors_template" type="x-tmpl-mustache/text">
                    <div class="col-md-12">
                        <p id="box_4_desc"></p>
                        
                    </div>
                </script>
            </div>
        </div>
    </div>
</div>

<style>
    .flexslider a:hover {
        text-decoration: none;
    }
    .flex-direction-nav a:before {
        font-size: 24px;
    }
    .store_logo_container {
        border: 1px solid #eee;    
    }
    .promo_list_name {
        margin-top: 10px;
    }
    .promo_dates {
        margin-bottom: 10px;
    }
    .read_more {
        margin-top: 0;
    }
    .newsletter_container {
        margin-top: 0;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
<script>
    $(document).ready(function(e){
        init(e);
        function renderAll(){
            var pageBanner = [];
            var banners = getRepoDetailsByName("Holiday Campaign Banner");
            if (banners && banners.images.length > 0) {
                try {
                    
                    pageBanner = banners.images
                } catch (e) {
                    pageBanner = [{ "image_url": "" }]
                }
            } else {
                pageBanner = [{ "image_url": "" }]
            }
            renderGeneral('#time_banner','#banner_template', pageBanner);

            // SECTION 1
            prefix = get_prefix();
            var page1_json = prefix + "/pages/halifaxcentre-holiday-campaign-intro-1.json"
            $.getJSON(page1_json).done(function(data) {
                $('#box_1_title').html(data.title.toUpperCase());
                $('#box_1_desc').html(data.body);
                $('#box_1_image').attr('src', data.image_url);
                $('#box_1_image').attr('alt', data.title);
            }).fail(function(jqXHR) {
                if (jqXHR.status == 404) {
                    $("#404_msg").fadeIn("fast");
                }
            });
            
            // SECTION 2
            var page2_json = prefix + "	/pages/halifaxcentre-holiday-campaign-intro-2.json"
            $.getJSON(page2_json).done(function(data) {
                const image = data.image_url;
                $('#box_2_title').html(data.title.toUpperCase());
                $('#box_2_desc').html(data.body);
                $('#box_2_image').attr('src', data.image_url);
                $('#box_2_image').attr('alt', data.title);
            }).fail(function(jqXHR) {
                if (jqXHR.status == 404) {
                    $("#404_msg").fadeIn("fast");
                }
            });
            
            // SECTION 3
            var page3_json = prefix + "/pages/halifaxcentre-holiday-campaign-intro-3.json"
            $.getJSON(page3_json).done(function(data) {
                const image = data.image_url;
                $('#box_3_page_title').html(data.title.toUpperCase());
                $('#box_3_page_desc').html(data.body);
                $('#box_3_page_image').attr('src', data.image_url);
                $('#box_3_page_image').attr('alt', data.title);
            }).fail(function(jqXHR) {
                if (jqXHR.status == 404) {
                    $("#404_msg").fadeIn("fast");
                }
            });
            
            // HOLIDAY HOURS
            
            
            // pseudo: get holiday hours (extended), actual holiday shortened hours, combine, display only Dec and Jan
            
            var extended_hours = getPropertyExtendedHours().sortBy(function(o){ return o.holiday_date });
            // format if no formatted date, add it
            
            // var ext_hours_formatted = () => {
            //     $.each( extended_hours , function( key, val ) {
            //         console.log(val)
            //         if (!val.formatted_date) {
            //             holiday = moment(val.holiday_date).tz(getPropertyTimeZone());
            //             var weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            //             val.formatted_date = holiday.format("ddd, MMM D, YYYY");
            //         }
            //     })
            // }
            // var holiday = moment(v.holiday_date).tz(getPropertyTimeZone());
            const ext_hours_formatted = extended_hours.map(v => ({...v, formatted_date: moment(v.holiday_date).tz(getPropertyTimeZone()).format("ddd, MMM D, YYYY") }))
            
            console.log(ext_hours_formatted)
            

            var holiday_hours = getPropertyHolidayHours().filter(function(o){ return o.is_closed === 0});
            const holiday_hours_formatted = holiday_hours.map(v => ({...v, formatted_date: moment(v.holiday_date).tz(getPropertyTimeZone()).format("ddd, MMM D, YYYY") }))
            
            console.log(holiday_hours_formatted)
            
            console.log(holiday_hours)
        
            const joined_hours = holiday_hours.concat(extended_hours)
            const sorted_hours = joined_hours.sortBy(function(o){ return o.holiday_date });
            console.log(sorted_hours)
            
            
            
            renderHours('#holidays_hours_container','#holidays_hours_template', sorted_hours, 'extended_hours')
            
            // HOLIADY EVENTS
            var events = getEventsList().sortBy(function(o){ return o.end_date });
            var published_events = [];
            $.each(events, function(key, val) {
                if (val.tags.includes('Holiday')) {
                    var today = moment();
                    var webDate = moment(val.show_on_web_date);
                    if (today >= webDate) {
                        if (val.name.length > 30) {
                            val.short_name = _.truncate(val.name, { 'length': 30, 'separator': ' ' });
                        } else {
                            val.short_name = val.name
                        }
                        published_events.push(val)
                    } 
                }
            });
            if (published_events.length > 0) {
                renderEvents("#promos_container","#promos_template", published_events, "Halifax Shopping Centre");
                $('#holiday_events').show();
            }
            
            // SECTION 4
            var page4_json = prefix + "/pages/halifaxcentre-holiday-campaign.json"
            $.getJSON(page4_json).done(function(data) {
                $('#box_4_title').html(data.title);
                $('#box_4_desc').html(data.body);
            }).fail(function(jqXHR) {
                if (jqXHR.status == 404) {
                    $("#404_msg").fadeIn("fast");
                }
            });
            
            show_content();
            
    		$('.flexslider').flexslider({
                animation: "slide",
                animationLoop: true,
                animationSpeed: 600,
                pauseOnAction: true,            
                pauseOnHover: true,            
                pauseInvisible: true,   
            });
        }
        
        loadMallDataCached(renderAll); 
    });
</script>